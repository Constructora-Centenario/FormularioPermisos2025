<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Solicitudes - Permisos, Incapacidades y Licencias</title>
    <base target="_top">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        <?!= include('styles'); ?>
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <a href="https://constructoracentenario.com" class="logo-link" target="_blank">
                <img src="https://constructoracentenario.com/wp-content/uploads/2024/04/LogoConstructoraCen2024.png" 
                     alt="Constructora Centenario" 
                     class="logo-image">
            </a>
        </div>

        <div class="header">
            <h1>Sistema de Solicitudes</h1>
            <p>Complete el formulario según su necesidad</p>
        </div>
        
        <div class="info-box">
            <h3><i class="fas fa-info-circle"></i> Información importante</h3>
            <p>Para iniciar, ingrese su número de cédula. El sistema buscará sus datos en nuestra base de datos.</p>
        </div>
        
        <div id="successMessage" class="success-message">
            <h3><i class="fas fa-check-circle"></i> ¡Solicitud enviada con éxito!</h3>
            <p>Se ha enviado su solicitud a revisión al área encargada.</p>
        </div>
        
        <div id="errorMessage" class="error-message">
            <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
            <p id="errorText"></p>
        </div>
        
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p id="loadingText">Buscando información, por favor espere...</p>
        </div>
        
        <!-- Formulario de validación por cédula -->
        <div id="cedulaFormContainer">
            <form id="cedulaForm">
                <div class="form-group">
                    <label for="cedula">Número de cédula <span class="required">*</span></label>
                    <input type="text" id="cedula" name="cedula" placeholder="Ingrese su número de cédula" required>
                    <div id="cedulaError" class="error">Por favor ingrese su número de cédula</div>
                </div>
                
                <button type="submit" class="btn"><i class="fas fa-search"></i> Buscar</button>
            </form>
        </div>
        
        <!-- Formulario de solicitud (inicialmente oculto) -->
        <div id="solicitudFormContainer" style="display: none;">
            <div class="user-info-box">
                <h3><i class="fas fa-user"></i> Información del usuario</h3>
                <div class="user-details">
                    <p><strong>Nombre:</strong> <span id="userNombre"></span></p>
                    <p><strong>Cédula:</strong> <span id="userCedula"></span></p>
                    <p><strong>Correo:</strong> <span id="userCorreo"></span></p>
                    <p><strong>Cargo:</strong> <span id="userCargo"></span></p>
                    <p><strong>Jefe inmediato:</strong> <span id="userJefe"></span></p>
                </div>
            </div>
            
            <form id="solicitudForm">
                <input type="hidden" id="cedulaUsuario" name="cedulaUsuario">
                <input type="hidden" id="nombreUsuario" name="nombreUsuario">
                <input type="hidden" id="correoUsuario" name="correoUsuario">
                <input type="hidden" id="cargoUsuario" name="cargoUsuario">
                <input type="hidden" id="jefeUsuario" name="jefeUsuario">
                <input type="hidden" id="correoJefe" name="correoJefe">
                
                <div class="form-group">
                    <label for="tipoSolicitud">Tipo de solicitud <span class="required">*</span></label>
                    <select id="tipoSolicitud" name="tipoSolicitud" required>
                        <option value="">Seleccione una opción</option>
                        <option value="permisos">Permisos</option>
                        <option value="incapacidades">Incapacidades</option>
                        <option value="licencias">Licencias</option>
                        <option value="compensacion">Compensación</option>
                    </select>
                    <div id="tipoSolicitudError" class="error">Por favor seleccione un tipo de solicitud</div>
                </div>
                
                <div id="opciones-container"></div>
                
                <!-- El campo de observaciones general ahora se ocultará para compensación -->
                <div class="form-group" id="observacionesContainer">
                    <label for="observaciones">Motivo de solicitud <span class="required">*</span></label>
                    <textarea id="observaciones" name="observaciones" placeholder="Describa el motivo de su solicitud, cómo va a recuperar el tiempo en caso de ser necesario, y cualquier información relevante..." required></textarea>
                    <div id="observacionesError" class="error">Por favor ingrese el motivo de la solicitud</div>
                </div>
                
                <!-- Campo de archivo adjunto, se ocultará para compensación -->
                <div class="form-group" id="soporteContainer">
                    <label for="soporte" id="soporteLabel">Adjuntar soporte <span class="required">*</span>
                        <button type="button" class="help-btn" id="helpBtn" title="Ver documentos requeridos">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </label>
                    <input type="file" id="soporte" name="soporte" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required>
                    <div class="file-info" id="fileInfo">Formatos aceptados: PDF, JPG, PNG, DOC, DOCX (Tamaño máximo: 5MB)</div>
                    <div id="filePreview" class="file-preview">
                        <i class="fas fa-file"></i> <span id="fileName">Ningún archivo seleccionado</span>
                    </div>
                    <div id="soporteError" class="error">Por favor adjunte el documento de soporte requerido</div>
                </div>
                
                <button type="submit" class="btn"><i class="fas fa-paper-plane"></i> Enviar Solicitud</button>
            </form>
        </div>
        
        <div class="footer">
            <p>Sistema de Gestión de Solicitudes © 2025 - Desarrollado con Google Apps Script</p>
        </div>
    </div>

    <!-- Modal de ayuda para documentos requeridos -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Documentos Requeridos</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="helpContent">
                    <p>Seleccione un tipo de solicitud para ver los documentos requeridos.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cedulaForm = document.getElementById('cedulaForm');
            const solicitudForm = document.getElementById('solicitudForm');
            const cedulaFormContainer = document.getElementById('cedulaFormContainer');
            const solicitudFormContainer = document.getElementById('solicitudFormContainer');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const loadingElement = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const fileInput = document.getElementById('soporte');
            const filePreview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const tipoSolicitud = document.getElementById('tipoSolicitud');
            const opcionesContainer = document.getElementById('opciones-container');
            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const closeModal = document.querySelector('.close');
            const helpContent = document.getElementById('helpContent');
            const soporteError = document.getElementById('soporteError');
            const observacionesContainer = document.getElementById('observacionesContainer');
            const observaciones = document.getElementById('observaciones');
            const observacionesError = document.getElementById('observacionesError');
            const soporteContainer = document.getElementById('soporteContainer');
            const soporteLabel = document.getElementById('soporteLabel');
            const fileInfo = document.getElementById('fileInfo');
            
            // Mostrar vista previa del archivo
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileName.textContent = this.files[0].name;
                    filePreview.style.display = 'block';
                    soporteError.style.display = 'none';
                } else {
                    filePreview.style.display = 'none';
                }
            });
            
            // Manejar envío del formulario de cédula
            cedulaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const cedula = document.getElementById('cedula').value;
                const cedulaError = document.getElementById('cedulaError');
                
                if (!cedula.trim()) {
                    cedulaError.style.display = 'block';
                    return;
                } else {
                    cedulaError.style.display = 'none';
                }
                
                // Mostrar loading
                loadingElement.style.display = 'block';
                loadingText.textContent = 'Buscando información, por favor espere...';
                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
                
                // Buscar información por cédula
                google.script.run
                    .withSuccessHandler(handleCedulaSuccess)
                    .withFailureHandler(handleCedulaFailure)
                    .buscarPorCedula(cedula);
            });
            
            function handleCedulaSuccess(result) {
                loadingElement.style.display = 'none';
                
                if (result.success) {
                    // Llenar los campos con la información del usuario
                    document.getElementById('userNombre').textContent = result.data.nombre;
                    document.getElementById('userCedula').textContent = result.data.cedula;
                    document.getElementById('userCorreo').textContent = result.data.correo;
                    document.getElementById('userCargo').textContent = result.data.cargo;
                    document.getElementById('userJefe').textContent = result.data.jefe;
                    
                    // Llenar los campos ocultos
                    document.getElementById('cedulaUsuario').value = result.data.cedula;
                    document.getElementById('nombreUsuario').value = result.data.nombre;
                    document.getElementById('correoUsuario').value = result.data.correo;
                    document.getElementById('cargoUsuario').value = result.data.cargo;
                    document.getElementById('jefeUsuario').value = result.data.jefe;
                    document.getElementById('correoJefe').value = result.data.correoJefe;
                    
                    // Mostrar formulario de solicitud y ocultar formulario de cédula
                    cedulaFormContainer.style.display = 'none';
                    solicitudFormContainer.style.display = 'block';
                } else {
                    errorText.textContent = result.message;
                    errorMessage.style.display = 'block';
                }
            }
            
            function handleCedulaFailure(error) {
                loadingElement.style.display = 'none';
                errorText.textContent = 'Error al buscar la cédula: ' + error.message;
                errorMessage.style.display = 'block';
            }
            
            // Manejar cambio en el tipo de solicitud
            tipoSolicitud.addEventListener('change', function() {
                const tipo = this.value;
                opcionesContainer.innerHTML = '';
                
                // Mostrar/Ocultar campo de observaciones general
                observacionesContainer.style.display = 'block';
                observaciones.required = true;
                
                // Mostrar/Ocultar campo de archivo adjunto
                soporteContainer.style.display = 'block';
                soporteLabel.style.display = 'block';
                fileInfo.style.display = 'block';
                fileInput.required = true;
                soporteError.style.display = 'none';
                
                if (tipo === 'permisos') {
                    opcionesContainer.innerHTML = `
                        <div class="form-group">
                            <label for="tipoPermiso">Tipo de permiso <span class="required">*</span></label>
                            <select id="tipoPermiso" name="tipoPermiso" required>
                                <option value="">Seleccione una opción</option>
                                <option value="Sufragio o voto">Sufragio o voto</option>
                                <option value="Jurado de votación">Jurado de votación</option>
                                <option value="Calamidad doméstica">Calamidad doméstica</option>
                                <option value="Comisión sindical">Comisión sindical</option>
                                <option value="Cita médica">Cita médica</option>
                                <option value="Estudiantes">Estudiantes</option>
                                <option value="Reunión de padres">Reunión de padres</option>
                                <option value="Citación de padres">Citación de padres</option>
                                <option value="Libreta militar">Libreta militar</option>
                                <option value="Licencia de conducción">Licencia de conducción</option>
                                <option value="Obligaciones escolares como acudiente">Obligaciones escolares como acudiente</option>
                                <option value="Citaciones judiciales, administrativas y legales">Citaciones judiciales, administrativas y legales</option>
                                <option value="Diligencias personales">Diligencias personales</option>
                                <option value="Estudio">Estudio</option>
                            </select>
                            <div id="tipoPermisoError" class="error">Por favor seleccione un tipo de permiso</div>
                        </div>
                        <div class="form-group">
                            <label for="fechaPermiso">Fecha del permiso <span class="required">*</span></label>
                            <input type="date" id="fechaPermiso" name="fechaPermiso" required>
                            <div id="fechaPermisoError" class="error">Por favor seleccione la fecha del permiso</div>
                        </div>
                        <div class="time-fields">
                            <div class="form-group">
                                <label for="horaInicioPermiso">Hora de inicio <span class="required">*</span></label>
                                <input type="time" id="horaInicioPermiso" name="horaInicioPermiso" required>
                                <div id="horaInicioPermisoError" class="error">Por favor seleccione la hora de inicio</div>
                            </div>
                            <div class="form-group">
                                <label for="horaFinPermiso">Hora de fin <span class="required">*</span></label>
                                <input type="time" id="horaFinPermiso" name="horaFinPermiso" required>
                                <div id="horaFinPermisoError" class="error">Por favor seleccione la hora de fin</div>
                            </div>
                        </div>
                    `;
                } 
                else if (tipo === 'incapacidades') {
                    opcionesContainer.innerHTML = `
                        <div class="form-group">
                            <label for="tipoIncapacidad">Tipo de incapacidad <span class="required">*</span></label>
                            <select id="tipoIncapacidad" name="tipoIncapacidad" required>
                                <option value="">Seleccione una opción</option>
                                <option value="Incapacidad por enfermedad general">Incapacidad por enfermedad general</option>
                                <option value="Incapacidad por accidente laboral">Incapacidad por accidente laboral</option>
                            </select>
                            <div id="tipoIncapacidadError" class="error">Por favor seleccione un tipo de incapacidad</div>
                        </div>
                        <div class="form-group">
                            <label for="fechaInicioIncapacidad">Fecha de inicio <span class="required">*</span></label>
                            <input type="date" id="fechaInicioIncapacidad" name="fechaInicioIncapacidad" required>
                            <div id="fechaInicioIncapacidadError" class="error">Por favor seleccione la fecha de inicio</div>
                        </div>
                        <div class="form-group">
                            <label for="fechaFinIncapacidad">Fecha de fin <span class="required">*</span></label>
                            <input type="date" id="fechaFinIncapacidad" name="fechaFinIncapacidad" required>
                            <div id="fechaFinIncapacidadError" class="error">Por favor seleccione la fecha de fin</div>
                        </div>
                    `;
                } 
                else if (tipo === 'licencias') {
                    opcionesContainer.innerHTML = `
                        <div class="form-group">
                            <label for="tipoLicencia">Tipo de licencia <span class="required">*</span></label>
                            <select id="tipoLicencia" name="tipoLicencia" required>
                                <option value="">Seleccione una opción</option>
                                <option value="Licencia de maternidad">Licencia de maternidad</option>
                                <option value="Licencia de paternidad">Licencia de paternidad</option>
                                <option value="Licencia por luto">Licencia por luto</option>
                            </select>
                            <div id="tipoLicenciaError" class="error">Por favor seleccione un tipo de licencia</div>
                        </div>
                    `;
                }
                else if (tipo === 'compensacion') {
                    // Para compensación, mostramos un campo específico y ocultamos el general
                    opcionesContainer.innerHTML = `
                        <div class="form-group">
                            <label for="motivoCompensacion">Motivo de compensación <span class="required">*</span></label>
                            <textarea id="motivoCompensacion" name="motivoCompensacion" placeholder="Describa detalladamente el motivo de la compensación, horarios a compensar, fechas y cualquier información relevante..." required></textarea>
                            <div id="motivoCompensacionError" class="error">Por favor ingrese el motivo de la compensación</div>
                        </div>
                    `;
                    
                    // Ocultamos el campo de observaciones general para compensación
                    observacionesContainer.style.display = 'none';
                    observaciones.required = false;
                    observacionesError.style.display = 'none';
                    
                    // Ocultamos el campo de archivo adjunto para compensación
                    soporteContainer.style.display = 'none';
                    soporteLabel.style.display = 'none';
                    fileInfo.style.display = 'none';
                    fileInput.required = false;
                    filePreview.style.display = 'none';
                    soporteError.style.display = 'none';
                }
                
                // Actualizar contenido de ayuda
                updateHelpContent();
            });
            
            // Sistema de ayuda para documentos requeridos
            helpBtn.addEventListener('click', function() {
                updateHelpContent();
                helpModal.style.display = 'block';
            });
            
            closeModal.addEventListener('click', function() {
                helpModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === helpModal) {
                    helpModal.style.display = 'none';
                }
            });
            
            function updateHelpContent() {
                const tipoSolicitudVal = document.getElementById('tipoSolicitud').value;
                const tipoDetalle = document.getElementById('tipoPermiso') ? document.getElementById('tipoPermiso').value : 
                                  document.getElementById('tipoIncapacidad') ? document.getElementById('tipoIncapacidad').value :
                                  document.getElementById('tipoLicencia') ? document.getElementById('tipoLicencia').value : '';
                
                let content = '';
                
                if (!tipoSolicitudVal) {
                    content = '<p>Seleccione un tipo de solicitud para ver los documentos requeridos.</p>';
                } else if (tipoSolicitudVal === 'licencias') {
                    if (tipoDetalle === 'Licencia de maternidad') {
                        content = `
                            <h4>Licencia de Maternidad</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Certificado nacido vivo</li>
                                <li>Registro civil de nacimiento</li>
                            </ul>
                        `;
                    } else if (tipoDetalle === 'Licencia de paternidad') {
                        content = `
                            <h4>Licencia de Paternidad</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Certificado nacido vivo</li>
                                <li>Registro civil de nacimiento</li>
                            </ul>
                        `;
                    } else if (tipoDetalle === 'Licencia por luto') {
                        content = `
                            <h4>Licencia por Luto</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Certificado de defunción</li>
                                <li>Registro civil de nacimiento para probar el parentesco (abuelos, papá, mamá, hermanos)</li>
                                <li>Certificado de matrimonio civil o religioso (cónyuge)</li>
                                <li>Declaración notarial de convivencia (Requerido si el fallecido era tu compañero o compañera permanente)</li>
                            </ul>
                            <div class="highlight-box">
                                <p><strong>Nota:</strong> La EPS tiene la obligación de prestar asesoría psicológica.</p>
                            </div>
                        `;
                    } else {
                        content = '<p>Seleccione un tipo de licencia específico para ver los documentos requeridos.</p>';
                    }
                } else if (tipoSolicitudVal === 'incapacidades') {
                    content = `
                        <h4>Incapacidades</h4>
                        <p><strong>Documentos requeridos:</strong></p>
                        <ul>
                            <li>Incapacidad médica</li>
                            <li>Historia clínica (si aplica)</li>
                        </ul>
                    `;
                } else if (tipoSolicitudVal === 'permisos') {
                    if (tipoDetalle === 'Estudiantes') {
                        content = `
                            <h4>Permisos Estudiantes</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Horario de clases</li>
                                <li>Comprobante de pago de matrícula</li>
                            </ul>
                        `;
                    } else if (tipoDetalle === 'Cita médica') {
                        content = `
                            <h4>Cita con Especialista</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Cita programada en la EPS (correo electrónico o PDF)</li>
                            </ul>
                        `;
                    } else if (tipoDetalle === 'Reunión de padres') {
                        content = `
                            <h4>Permiso para Reunión de Padres</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Chat de WhatsApp o correo electrónico programando la reunión</li>
                            </ul>
                        `;
                    } else if (tipoDetalle === 'Citación de padres') {
                        content = `
                            <h4>Permiso para Citación de Padres</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Chat de WhatsApp o correo electrónico de la citación</li>
                            </ul>
                        `;
                    } else if (tipoDetalle === 'Libreta militar' || tipoDetalle === 'Licencia de conducción') {
                        content = `
                            <h4>Permiso para ${tipoDetalle}</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Cita programada por la entidad correspondiente</li>
                            </ul>
                        `;
                    } else if (tipoDetalle) {
                        content = `
                            <h4>${tipoDetalle}</h4>
                            <p><strong>Documentos requeridos:</strong></p>
                            <ul>
                                <li>Documento que justifique el motivo del permiso</li>
                                <li>Si aplica, comprobante de la actividad o cita</li>
                            </ul>
                        `;
                    } else {
                        content = '<p>Seleccione un tipo de permiso específico para ver los documentos requeridos.</p>';
                    }
                } else if (tipoSolicitudVal === 'compensacion') {
                    content = `
                        <h4>Compensación de Horas</h4>
                        <p><strong>Información importante:</strong></p>
                        <p>La compensación permite recuperar horas trabajadas en exceso o en horarios especiales.</p>
                        <p><strong>Nota:</strong> Para solicitudes de compensación NO se requiere adjuntar documento de soporte.</p>
                        <div class="highlight-box">
                            <p><strong>Documentación requerida (posterior):</strong></p>
                            <ul>
                                <li>Formato de autorización de horas extras (si aplica)</li>
                                <li>Reporte de horas trabajadas</li>
                                <li>Autorización del jefe inmediato</li>
                            </ul>
                            <p><strong>Importante:</strong> La compensación debe ser aprobada previamente por el jefe inmediato y el área de gestión humana.</p>
                        </div>
                    `;
                }
                
                helpContent.innerHTML = content;
            }
            
            // Manejar envío del formulario de solicitud
            solicitudForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateForm()) {
                    // Mostrar loading
                    loadingElement.style.display = 'block';
                    loadingText.textContent = 'Generando PDF, adjuntando archivo y enviando solicitud, por favor espere...';
                    successMessage.style.display = 'none';
                    errorMessage.style.display = 'none';
                    
                    // Obtener datos del formulario
                    const formData = getFormData();
                    
                    // Procesar archivo si existe y si no es compensación
                    const file = fileInput.files[0];
                    const tipoSolicitudVal = document.getElementById('tipoSolicitud').value;
                    
                    if (file && tipoSolicitudVal !== 'compensacion') {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const fileBytes = e.target.result.split(',')[1];
                            const fileName = file.name;
                            const fileType = file.type;
                            
                            // Enviar datos al servidor
                            google.script.run
                                .withSuccessHandler(handleSuccess)
                                .withFailureHandler(handleFailure)
                                .processForm(formData, fileBytes, fileName, fileType);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // Enviar datos al servidor sin archivo (para compensación o sin archivo)
                        google.script.run
                            .withSuccessHandler(handleSuccess)
                            .withFailureHandler(handleFailure)
                            .processForm(formData, null, '', '');
                    }
                }
            });
            
            function getFormData() {
                const formData = {
                    cedula: document.getElementById('cedulaUsuario').value,
                    nombre: document.getElementById('nombreUsuario').value,
                    correo: document.getElementById('correoUsuario').value,
                    cargo: document.getElementById('cargoUsuario').value,
                    jefe: document.getElementById('jefeUsuario').value,
                    correoJefe: document.getElementById('correoJefe').value,
                    tipoSolicitud: document.getElementById('tipoSolicitud').value
                };
                
                // Agregar datos específicos según el tipo de solicitud
                if (formData.tipoSolicitud === 'permisos') {
                    const select = document.getElementById('tipoPermiso');
                    formData.tipoDetalle = select.value;
                    formData.tipoDetalleTexto = select.options[select.selectedIndex].text;
                    formData.fechaPermiso = document.getElementById('fechaPermiso').value;
                    formData.horaInicioPermiso = document.getElementById('horaInicioPermiso').value;
                    formData.horaFinPermiso = document.getElementById('horaFinPermiso').value;
                    formData.observaciones = document.getElementById('observaciones').value;
                } 
                else if (formData.tipoSolicitud === 'incapacidades') {
                    const select = document.getElementById('tipoIncapacidad');
                    formData.tipoDetalle = select.value;
                    formData.tipoDetalleTexto = select.options[select.selectedIndex].text;
                    formData.fechaInicio = document.getElementById('fechaInicioIncapacidad').value;
                    formData.fechaFin = document.getElementById('fechaFinIncapacidad').value;
                    formData.observaciones = document.getElementById('observaciones').value;
                } 
                else if (formData.tipoSolicitud === 'licencias') {
                    const select = document.getElementById('tipoLicencia');
                    formData.tipoDetalle = select.value;
                    formData.tipoDetalleTexto = select.options[select.selectedIndex].text;
                    formData.observaciones = document.getElementById('observaciones').value;
                }
                else if (formData.tipoSolicitud === 'compensacion') {
                    formData.tipoDetalle = 'Compensación';
                    formData.tipoDetalleTexto = 'Compensación';
                    // Para compensación, usamos el motivo específico como observaciones
                    formData.observaciones = document.getElementById('motivoCompensacion').value;
                }
                
                return formData;
            }
            
            function handleSuccess(result) {
                loadingElement.style.display = 'none';
                
                if (result.success) {
                    successMessage.style.display = 'block';
                    successMessage.scrollIntoView({ behavior: 'smooth' });
                    solicitudForm.reset();
                    
                    // Restablecer visibilidad de los elementos ocultos
                    soporteContainer.style.display = 'block';
                    soporteLabel.style.display = 'block';
                    fileInfo.style.display = 'block';
                    fileInput.required = true;
                    filePreview.style.display = 'none';
                    opcionesContainer.innerHTML = '';
                    observacionesContainer.style.display = 'block';
                    observaciones.required = true;
                    
                    // Ocultar mensaje después de 5 segundos
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                        // Volver al formulario de cédula
                        cedulaFormContainer.style.display = 'block';
                        solicitudFormContainer.style.display = 'none';
                        document.getElementById('cedula').value = '';
                    }, 5000);
                } else {
                    errorText.textContent = result.message;
                    errorMessage.style.display = 'block';
                }
            }
            
            function handleFailure(error) {
                loadingElement.style.display = 'none';
                errorText.textContent = 'Error al enviar el formulario: ' + error.message;
                errorMessage.style.display = 'block';
            }
            
            function validateForm() {
                let isValid = true;
                
                // Validar tipo de solicitud
                const tipoSolicitudVal = document.getElementById('tipoSolicitud');
                const tipoSolicitudError = document.getElementById('tipoSolicitudError');
                if (!tipoSolicitudVal.value) {
                    tipoSolicitudError.style.display = 'block';
                    isValid = false;
                } else {
                    tipoSolicitudError.style.display = 'none';
                }
                
                // Validar opciones específicas según el tipo
                if (tipoSolicitudVal.value === 'permisos') {
                    const tipoPermiso = document.getElementById('tipoPermiso');
                    const tipoPermisoError = document.getElementById('tipoPermisoError');
                    if (!tipoPermiso || !tipoPermiso.value) {
                        tipoPermisoError.style.display = 'block';
                        isValid = false;
                    } else {
                        tipoPermisoError.style.display = 'none';
                    }
                    
                    const fechaPermiso = document.getElementById('fechaPermiso');
                    const fechaPermisoError = document.getElementById('fechaPermisoError');
                    if (!fechaPermiso || !fechaPermiso.value) {
                        fechaPermisoError.style.display = 'block';
                        isValid = false;
                    } else {
                        fechaPermisoError.style.display = 'none';
                    }
                    
                    const horaInicioPermiso = document.getElementById('horaInicioPermiso');
                    const horaInicioPermisoError = document.getElementById('horaInicioPermisoError');
                    if (!horaInicioPermiso || !horaInicioPermiso.value) {
                        horaInicioPermisoError.style.display = 'block';
                        isValid = false;
                    } else {
                        horaInicioPermisoError.style.display = 'none';
                    }
                    
                    const horaFinPermiso = document.getElementById('horaFinPermiso');
                    const horaFinPermisoError = document.getElementById('horaFinPermisoError');
                    if (!horaFinPermiso || !horaFinPermiso.value) {
                        horaFinPermisoError.style.display = 'block';
                        isValid = false;
                    } else {
                        horaFinPermisoError.style.display = 'none';
                    }
                    
                    // Validar que la hora de fin sea posterior a la hora de inicio
                    if (horaInicioPermiso.value && horaFinPermiso.value && horaInicioPermiso.value >= horaFinPermiso.value) {
                        horaFinPermisoError.textContent = 'La hora de fin debe ser posterior a la hora de inicio';
                        horaFinPermisoError.style.display = 'block';
                        isValid = false;
                    }
                    
                    // Validar motivo de solicitud general
                    const observacionesVal = document.getElementById('observaciones');
                    const observacionesError = document.getElementById('observacionesError');
                    if (!observacionesVal.value.trim()) {
                        observacionesError.style.display = 'block';
                        isValid = false;
                    } else {
                        observacionesError.style.display = 'none';
                    }
                    
                    // Validar archivo adjunto para permisos
                    if (!fileInput.files.length) {
                        soporteError.style.display = 'block';
                        isValid = false;
                    } else {
                        soporteError.style.display = 'none';
                    }
                } 
                else if (tipoSolicitudVal.value === 'incapacidades') {
                    const tipoIncapacidad = document.getElementById('tipoIncapacidad');
                    const tipoIncapacidadError = document.getElementById('tipoIncapacidadError');
                    if (!tipoIncapacidad || !tipoIncapacidad.value) {
                        tipoIncapacidadError.style.display = 'block';
                        isValid = false;
                    } else {
                        tipoIncapacidadError.style.display = 'none';
                    }
                    
                    const fechaInicio = document.getElementById('fechaInicioIncapacidad');
                    const fechaInicioError = document.getElementById('fechaInicioIncapacidadError');
                    if (!fechaInicio || !fechaInicio.value) {
                        fechaInicioError.style.display = 'block';
                        isValid = false;
                    } else {
                        fechaInicioError.style.display = 'none';
                    }
                    
                    const fechaFin = document.getElementById('fechaFinIncapacidad');
                    const fechaFinError = document.getElementById('fechaFinIncapacidadError');
                    if (!fechaFin || !fechaFin.value) {
                        fechaFinError.style.display = 'block';
                        isValid = false;
                    } else {
                        fechaFinError.style.display = 'none';
                    }
                    
                    // Validar que la fecha de fin sea posterior a la de inicio
                    if (fechaInicio.value && fechaFin.value && new Date(fechaInicio.value) > new Date(fechaFin.value)) {
                        fechaFinError.textContent = 'La fecha de fin debe ser posterior a la fecha de inicio';
                        fechaFinError.style.display = 'block';
                        isValid = false;
                    }
                    
                    // Validar motivo de solicitud general
                    const observacionesVal = document.getElementById('observaciones');
                    const observacionesError = document.getElementById('observacionesError');
                    if (!observacionesVal.value.trim()) {
                        observacionesError.style.display = 'block';
                        isValid = false;
                    } else {
                        observacionesError.style.display = 'none';
                    }
                    
                    // Validar archivo adjunto para incapacidades
                    if (!fileInput.files.length) {
                        soporteError.style.display = 'block';
                        isValid = false;
                    } else {
                        soporteError.style.display = 'none';
                    }
                } 
                else if (tipoSolicitudVal.value === 'licencias') {
                    const tipoLicencia = document.getElementById('tipoLicencia');
                    const tipoLicenciaError = document.getElementById('tipoLicenciaError');
                    if (!tipoLicencia || !tipoLicencia.value) {
                        tipoLicenciaError.style.display = 'block';
                        isValid = false;
                    } else {
                        tipoLicenciaError.style.display = 'none';
                    }
                    
                    // Validar motivo de solicitud general
                    const observacionesVal = document.getElementById('observaciones');
                    const observacionesError = document.getElementById('observacionesError');
                    if (!observacionesVal.value.trim()) {
                        observacionesError.style.display = 'block';
                        isValid = false;
                    } else {
                        observacionesError.style.display = 'none';
                    }
                    
                    // Validar archivo adjunto para licencias
                    if (!fileInput.files.length) {
                        soporteError.style.display = 'block';
                        isValid = false;
                    } else {
                        soporteError.style.display = 'none';
                    }
                }
                else if (tipoSolicitudVal.value === 'compensacion') {
                    // Para compensación, validamos solo el campo específico
                    const motivoCompensacion = document.getElementById('motivoCompensacion');
                    const motivoCompensacionError = document.getElementById('motivoCompensacionError');
                    if (!motivoCompensacion || !motivoCompensacion.value.trim()) {
                        motivoCompensacionError.style.display = 'block';
                        isValid = false;
                    } else {
                        motivoCompensacionError.style.display = 'none';
                    }
                    
                    // Para compensación, NO validamos el campo de observaciones general
                    observacionesError.style.display = 'none';
                    
                    // Para compensación, NO validamos el archivo adjunto
                    soporteError.style.display = 'none';
                }
                
                return isValid;
            }
        });
    </script>
</body>
</html>